<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>จัดการกิจกรรม</title>

    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="css/ionicons.min.css" />
    <link rel="stylesheet" href="css/adminlte.min.css" />
    <link rel="stylesheet" href="css/skin.min.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css"
    />
  </head>

  <body class="skin-blue">
    <div class="wrapper">
      <header class="main-header">
        <a href="index.html" class="logo">
          <span class="logo-mini"><b>A</b>LT</span>
          <span class="logo-lg">Event KU</span>
        </a>
        <nav class="navbar navbar-static-top" role="navigation">
          <a
            href="#"
            class="sidebar-toggle"
            data-toggle="push-menu"
            role="button"
          >
            <span class="sr-only">Toggle navigation</span>
          </a>
          <div class="navbar-custom-menu">
            <ul class="nav navbar-nav">
              <li class="dropdown user user-menu">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                  <img
                    src="img/profile.jpeg"
                    class="user-image"
                    alt="User Image"
                  />
                  <span class="hidden-xs">Alexander Pierce</span>
                </a>
                <ul class="dropdown-menu">
                  <li class="user-header">
                    <img
                      src="img/profile.jpeg"
                      class="img-circle"
                      alt="User Image"
                    />
                    <p>
                      พนักงาน
                      <small>Member since Nov. 2012</small>
                    </p>
                  </li>
                  <li class="user-body">
                    <div class="row">
                      <div class="col-xs-4 text-center">
                        <div>
                          <p>พนักงาน</p>
                        </div>
                      </div>
                    </div>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
      </header>

      <aside class="main-sidebar">
        <section class="sidebar">
          <ul class="sidebar-menu" data-widget="tree">
            <li class="header">เมนู</li>
            <li class="active">
              <a href="index.html"
                ><i class="fa fa-link"></i> <span>จัดการกิจกรรม</span></a
              >
            </li>
            <li>
              <a href="manageLocation.html"
                ><i class="fa fa-link"></i>
                <span>จัดการอาคารหรือสถานที่</span></a
              >
            </li>
            <li>
              <a href="managePersonel.html"
                ><i class="fa fa-link"></i> <span>จัดการบุคลากร</span></a
              >
            </li>
            <li>
              <a href="manageRoom.html"
                ><i class="fa fa-link"></i> <span>จัดการห้อง</span></a
              >
            </li>
            <li>
              <a href="manageFaculty.html"
                ><i class="fa fa-link"></i> <span>จัดการหน่วยงานหลัก</span></a
              >
            </li>
            <li>
              <a href="manageBranch.html"
                ><i class="fa fa-link"></i> <span>จัดการหน่วยงานย่อย</span></a
              >
            </li>
            <li class="treeview">
              <a href="#"
                ><i class="fa fa-link"></i> <span>ตั้งค่า</span>
                <span class="pull-right-container">
                  <i class="fa fa-angle-left pull-right"></i>
                </span>
              </a>
              <ul class="treeview-menu">
                <li><a href="#">ตั้งค่าผู้ใช้</a></li>
                <li><a href="#">ออกจากระบบ</a></li>
              </ul>
            </li>
          </ul>
        </section>
      </aside>

      <div class="content-wrapper">
        <section class="content-header">
          <h1>แก้ไขกิจกรรมและการจัดงาน</h1>
        </section>

        <section class="content">
          <div class="row">
            <div class="col-md-11">
              <div class="">
                <h5 class="" style="font-weight: bold">ชื่อกิจกรรม :</h5>
                <input
                  placeholder="ชื่อกิจกรรม"
                  id="name"
                  name="eventName"
                  class="form-control"
                  type="text"
                />
              </div>
            </div>
            <div class="col-md-11">
              <div class="col">
                <h5 style="font-weight: bold">อาคาร :</h5>
                <select
                  id="Bding"
                  name="Bding"
                  class="form-control"
                  aria-label="Default select example"
                ></select>
              </div>
              <div class="col">
                <h5 style="font-weight: bold">ห้อง :</h5>
                <select id="room" name="room" class="form-control">
                  <option selected value="">เลือก</option>
                </select>
              </div>
              <div class="col">
                <h5 style="font-weight: bold">บุคลากรที่รับผิดชอบ :</h5>
                <select
                  id="personnel"
                  name="personnel"
                  class="form-control"
                ></select>
              </div>
              <div class="col">
                <h5 style="font-weight: bold">หน่วยงานหลักที่รับผิดชอบ :</h5>
                <select
                  id="mainOrg"
                  name="mainOrg"
                  class="form-control"
                ></select>
              </div>
              <div class="col">
                <h5 style="font-weight: bold">หน่วยงานรองที่รับผิดชอบ :</h5>
                <select id="subOrg" name="subOrg" class="form-control">
                  <option selected value="">เลือก</option>
                </select>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div>
                <h5 style="font-weight: bold">เลือกรูปที่ต้องการ :</h5>
                <input
                  class="form-control form-control-lg"
                  id="formFileLg"
                  name="img"
                  type="file"
                />
              </div>
            </div>
            <div id="img" class="col-md-6"></div>
          </div>
          <div class="row">
            <div class="form-group col-md-6" style="margin-top: 18px">
              <h5 style="font-weight: bold">เลือกวันที่และเวลา:</h5>
              <div class="input-group">
                <div class="input-group-addon">
                  <i class="fa fa-calendar"></i>
                </div>
                <input
                  name="time_period"
                  type="text"
                  class="form-control pull-right"
                  id="datetimepicker"
                />
              </div>
            </div>
            <div class="col-md-11">
              <h5 style="font-weight: bold">รายละเอียด :</h5>
              <textarea
                id="detail"
                name="detail"
                class="form-control"
                style="width: 100%"
                rows="17"
              ></textarea>
            </div>
          </div>
          <button
            onclick="confirm()"
            class="btn btn-primary"
            style="margin-top: 10px"
          >
            <i style="margin-right: 10px" class="bi bi-save2"></i>บันทึกข้อมูล
          </button>
        </section>
      </div>
      <div class="control-sidebar-bg"></div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/adminlte.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.10.0/jquery.timepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.1/dist/sweetalert2.all.min.js"></script>
    <script>
      $(function () {
        // Date and Time picker
        $("#datetimepicker").daterangepicker({
          timePicker: true,
          timePickerIncrement: 15,
          locale: {
            format: "YYYY-MM-DD HH:mm:ss",
            applyLabel: "Apply",
            cancelLabel: "Cancel",
            customRangeLabel: "Custom Range",
          },
        });
        $("#Bding").change(async (e) => {
          let locationId = e.target.value;
          let RoomOptions = `<option value="">เลือก</option>`;

          if (locationId) {
            try {
              let Rooms = await getRoom(locationId);
              RoomOptions += Rooms.map((Room) => {
                return `<option value="${Room.id}">${Room.room_number} ${Room.name}</option>`;
              }).join("");
            } catch (error) {
              Swal.fire({
                title: "มีบางอย่างผิดพลาด",
                icon: "error",
                confirmButtonText: "ยืนยัน",
              });
            }
          }

          $("#room").html(RoomOptions);
        });
        $("#mainOrg").change(async (e) => {
          let Facultyid = e.target.value;
          let branchOptions = `<option value="">เลือก</option>`;

          if (Facultyid) {
            try {
              let Branches = await getbranch(Facultyid);
              branchOptions += Branches.map((Branch) => {
                return `<option value="${Branch.id}">${Branch.name}</option>`;
              }).join("");
            } catch (error) {
              Swal.fire({
                title: "มีบางอย่างผิดพลาด",
                icon: "error",
                confirmButtonText: "ยืนยัน",
              });
            }
          }

          $("#subOrg").html(branchOptions);
        });
        async function loadEvent() {
          const urlParams = new URLSearchParams(window.location.search);
          const id = urlParams.get("id");

          ////options
          let RoomOptions = `<option value="">เลือก</option>`;
          let LocationOptions = `<option value="">เลือก</option>`;
          let PersonalOptions = `<option value="">เลือก</option>`;
          let MainOrgOptions = `<option value="">เลือก</option>`;
          let SubOrgOptions = `<option value="">เลือก</option>`;

          if (id) {
            let event = await getEvent(id);

            let rooms = await getRoom(event.location_id);
            RoomOptions += rooms
              .map((room) => {
                return event.room_id == room.id
                  ? `<option selected value="${room.id}">${room.room_number} ${room.name}</option>`
                  : `<option value="${room.id}">${room.room_number} ${room.name}</option>`;
              })
              .join("");

            let locations = await getLocation();
            LocationOptions += locations
              .map((location) => {
                return event.location_id == location.id
                  ? `<option selected value="${location.id}">${location.name}</option>`
                  : `<option value="${location.id}">${location.name}</option>`;
              })
              .join("");

            let personals = await getPersonal();
            PersonalOptions += personals
              .map((personal) => {
                return event.personnel_id == personal.id
                  ? `<option selected value="${personal.id}">${personal.first_name} ${personal.last_name} รหัสประจำตัว : ${personal.personnel_number}</option>`
                  : `<option value="${personal.id}">${personal.first_name} ${personal.last_name} รหัสประจำตัว : ${personal.personnel_number}</option>`;
              })
              .join("");

            let mainOrgs = await getfaculty();
            MainOrgOptions += mainOrgs
              .map((faculty) => {
                return event.faculty_id == faculty.id
                  ? `<option selected value="${faculty.id}">${faculty.name}</option>`
                  : `<option value="${faculty.id}">${faculty.name}</option>`;
              })
              .join("");

            let subOrgs = await getbranch(event.faculty_id);
            SubOrgOptions += subOrgs
              .map((branch) => {
                return event.branch_id == branch.id
                  ? `<option selected value="${branch.id}">${branch.name}</option>`
                  : `<option value="${branch.id}">${branch.name}</option>`;
              })
              .join("");

            $("#name").val(event.name);
            $("#detail").val(event.description);
            $("#Bding").html(LocationOptions);
            $("#room").html(RoomOptions);
            $("#personnel").html(PersonalOptions);
            $("#mainOrg").html(MainOrgOptions);
            $("#subOrg").html(SubOrgOptions);
            $("#datetimepicker").val(event.start_date + " - " + event.end_date);
          }
        }

        async function getEvent(id) {
          return new Promise((resolve, reject) => {
            $.ajax({
              url: `../api/getEvent.php?id=${id}`,
              type: "GET",
              success: function (response) {
                resolve(JSON.parse(response));
              },
              error: function (error) {
                reject(error);
              },
            });
          });
        }

        loadEvent();
      });

      function confirm() {
        let name = $("#name").val();
        let detail = $("#detail").val();
        let Bding = $("#Bding").val();
        let room = $("#room").val();
        let personnel = $("#personnel").val();
        let mainOrg = $("#mainOrg").val();
        let subOrg = $("#subOrg").val();
        let reteDate = $("#datetimepicker").val();
        let formFile = $("#formFileLg")[0].files[0];

        if (
          Bding == "เลือกอาคาร" ||
          room == "เลือกห้อง" ||
          personnel == "เลือกบุคลากรที่รับผิดชอบ" ||
          mainOrg == "เลือกหน่วยงานหลักที่รับผิดชอบ" ||
          subOrg == "เลือกหน่วยงานรองที่รับผิดชอบ" ||
          name == "" ||
          detail == "" ||
          reteDate == ""
        ) {
          Swal.fire({
            title: "โปรดใส่ข้อมูลให้ถูกต้อง",
            icon: "error",
            confirmButtonText: "ยืนยัน",
          });
          return;
        }

        Swal.fire({
          title: "ยืนยันการบันทึก",
          icon: "info",
          showCancelButton: true,
          confirmButtonText: "ยืนยัน",
          cancelButtonText: "ยกเลิก",
        }).then((resp) => {
          if (resp.isConfirmed) {
            let formData = new FormData();
            formData.append("name", name);
            formData.append("detail", detail);
            formData.append("Bding", Bding);
            formData.append("room", room);
            formData.append("personnel", personnel);
            formData.append("mainOrg", mainOrg);
            formData.append("subOrg", subOrg);
            formData.append("time_period", reteDate);
            if (formFile) {
              formData.append("img", formFile);
            }

            $.ajax({
              type: "POST",
              url: "../api/updateEvent.php",
              data: formData,
              processData: false,
              contentType: false,
              success: function (response) {
                let res = JSON.parse(response);
                if (res.status == "success") {
                  Swal.fire({
                    title: "บันทึกสำเร็จ",
                    icon: "success",
                    confirmButtonText: "ยืนยัน",
                  }).then(() => {
                    window.location.href = "index.html";
                  });
                } else {
                  Swal.fire({
                    title: "เกิดข้อผิดพลาด",
                    text: res.message,
                    icon: "error",
                    confirmButtonText: "ยืนยัน",
                  });
                }
              },
              error: function (error) {
                Swal.fire({
                  title: "เกิดข้อผิดพลาด",
                  text: "ไม่สามารถบันทึกข้อมูลได้",
                  icon: "error",
                  confirmButtonText: "ยืนยัน",
                });
              },
            });
          }
        });
      }

      function getPersonal() {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: "../api/getPersonnel.php",
            type: "GET",
            success: function (response) {
              resolve(JSON.parse(response));
            },
            error: function (error) {
              reject(error);
            },
          });
        });
      }

      function getRoom(locationId) {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: `../api/getRoom.php?location=${locationId}`,
            type: "GET",
            success: function (response) {
              try {
                resolve(JSON.parse(response));
              } catch (e) {
                reject(new Error("Failed to parse JSON response"));
              }
            },
            error: function (error) {
              reject(error);
            },
          });
        });
      }

      function getLocation() {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: "../api/getLocation.php",
            type: "GET",
            success: function (response) {
              resolve(JSON.parse(response));
            },
            error: function (error) {
              reject(error);
            },
          });
        });
      }

      function getfaculty() {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: "../api/getfaculty.php",
            type: "GET",
            success: function (response) {
              resolve(JSON.parse(response));
            },
            error: function (error) {
              reject(error);
            },
          });
        });
      }

      function getbranch(Facultyid) {
        return new Promise((resolve, reject) => {
          $.ajax({
            url: `../api/getbranch.php?Facultyid=${Facultyid}`,
            type: "GET",
            success: function (response) {
              resolve(JSON.parse(response));
            },
            error: function (error) {
              reject(error);
            },
          });
        });
      }
    </script>
  </body>
</html>
